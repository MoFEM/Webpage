<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=9"/>
  <meta name="generator" content="Doxygen 1.12.0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MoFEM: MIX-0: Mixed formulation of Poisson equation</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
  <script type="text/javascript " src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML "></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["AMSmath.js"],
        TeX: { equationNumbers: { autoNumber: ["all"],
                                  useLabelIds: true
        } 
        }
    });
    </script>
  <link href="customdoxygen.css" rel="stylesheet" type="text/css" />
  <link href="extra_style.css" rel="stylesheet" type="text/css"/>
  <link rel="apple-touch-icon" sizes="57x57" href="apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" type="image/png" href="favicon-32x32.png"/>
  <link rel="Bookmark" type="image/png" href="favicon-32x32.png"/>
  <link rel="manifest" href="manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div style="background-color:#011A40" id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 30px;">
  <td id="projectlogo"><img alt="Logo" src="MoFEMLogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <td style="padding-left: 0.5em;" bgcolor="#011A40"
   <div id="projectbrief"><font color="#FFFFFF">v0.14.0</font></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!--Google analytics tags-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-65236130-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2J9RE2P3H5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2J9RE2P3H5');
</script>
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">MIX-0: Mixed formulation of Poisson equation</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#mix_poisson_introduction">Introduction and motivation</a>
  </li>
  <li class="level1">
    <a href="#mix_poisson_weak_form">Derivation of the mixed weak form for the Poisson equation</a>
  </li>
  <li class="level1">
    <a href="#mix_poisson_code">Implementation</a>
    <ul>
      <li class="level2">
        <a href="#mix_poisson_assemble">Assembling the system</a>
      </li>
      <li class="level2">
        <a href="#mix_poisson_error_op">Operators for computing error indicators</a>
      </li>
      <li class="level2">
        <a href="#mix_poisson_ref">Algorithm of adaptive p-refinement</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#mix_poisson_example">Example</a>
  </li>
</ul>
</div>
<div class="textblock"><dl class="section note"><dt>Note</dt><dd>Prerequisites of this tutorial include <a class="el" href="basic_tutorials_poisson_homogeneous.html">SCL-1: Poisson's equation (homogeneous BC)</a> and <a class="el" href="hierarchical_approximation_1.html">FUN-2: Hierarchical approximation</a></dd></dl>
<p><br  />
</p>
<dl class="section note"><dt>Note</dt><dd>Intended learning outcome:<ul>
<li>Motivation for using mixed problem formulation</li>
<li>Derivation of the mixed weak form for the Poisson equation</li>
<li>Preliminaries for function spaces L2 and <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a></li>
<li>Implementation of the mixed weak form and error indicators</li>
<li>Convergence analysis for p-adaptive refinement</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="mix_poisson_introduction"></a>
Introduction and motivation</h1>
<p>We will start this tutorial by introducing the idea of the <em>mixed form</em> and its difference from the coupled problem formulation. In case of the coupled problem, we consider the interplay between two (or more) sub-problems governed by different physical equations and therefore described by two (or more) fields. Examples of coupled problems include thermoelasticity, electroelasticity, fluid-structure interaction and many others. On the contrary, mixed problem formulation is obtained upon introduction of one (or more) auxiliary variable(s) in a problem governed by one physical process. Examples of classical problems permitting (and benefiting from) such formulation are:</p><ul>
<li><a class="el" href="struct_incompressible.html">Incompressible</a> elasticity (auxiliary variable: hydrostatic pressure)</li>
<li>Stokes/Navier-Stokes problem for viscous incompressible flow (auxiliary variable: fluid pressure)</li>
<li>Convection-Reaction-Diffusion problem (auxiliary variable: flux)</li>
<li>Mechanical contact problem (auxiliary variable: contact pressure).</li>
</ul>
<p>There are multiple reasons for using mixed formulation, see <a class="el" href="citelist.html#CITEREF_boffi2013mixed">[14]</a> for more details:</p><ul>
<li>Presence of constraints in a problem under study (incompressible elasticity/fluid flow, contact problem)</li>
<li>Importance of new variables appearing in the formulation (accurate computation of stresses in elastic problem and fluxes in diffusion problem)</li>
<li>Possibility to obtain weaker formulation with less requirements on the regularity of the solution</li>
<li>Embedded reliable and efficient <em>a posteriori</em> error estimates.</li>
</ul>
<p>Note that in this tutorial particular attention will be given to the error estimators naturally emerging within the mixed formulation and permitting easy implementation of adaptive refinement.</p>
<h1><a class="anchor" id="mix_poisson_weak_form"></a>
Derivation of the mixed weak form for the Poisson equation</h1>
<p>The strong form of the boundary value problem for the Poisson equation reads:      </p><p class="formulaDsp">
\[
\begin{align}
\label{eq:poisson}-\textrm{div}\:(\nabla u) = f &amp; \quad \textrm{in}\; \Omega \\
\label{eq:dirichlet}u = 0 &amp; \quad \textrm{on}\; \partial\Omega,
\end{align}
\]
</p>
<p> where the homogeneous Dirichlet boundary condition is imposed on the whole boundary of the domain. In order to obtain the mixed formulation, we introduce a new variable \(\mathbf{q}\) representing the flux and rewrite the statement of the problem as follows:       </p><p class="formulaDsp">
\[
\begin{align}
\label{eq:flux}\mathbf{q} &amp;= \nabla u &amp; \textrm{in}\; \Omega\\
\label{eq:cont}-\textrm{div}\,\mathbf{q} &amp;= f &amp; \textrm{in}\; \Omega\\
\label{eq:bc}u &amp;= 0 &amp; \textrm{on}\; \partial\Omega.
\end{align}
\]
</p>
<p>We then multiply the left and right hand sides of Eqs. \eqref{eq:flux} and \eqref{eq:cont} by test functions \(\delta\mathbf{q}\) and \(\delta u\), respectively, and integrate over the domain:      </p><p class="formulaDsp">
\[
\begin{align}
\label{eq:flux_int}\int_{\Omega}\mathbf{q}\cdot\delta\mathbf{q}\,\textrm{d}\Omega - \int_{\Omega}\nabla u \cdot \delta\mathbf{q} \,\textrm{d}\Omega &amp;= 0 \\
-\int_{\Omega}\textrm{div}\,\mathbf{q}\delta u \,\textrm{d}\Omega &amp;= \int_{\Omega}f\, \delta u \,\textrm{d}\Omega 
\end{align}
\]
</p>
<p>We now notice that the second term in \eqref{eq:flux_int} can be integrated by parts, providing:      </p><p class="formulaDsp">
\[
\begin{align}
\label{eq:flux_int_part}\int_{\Omega}\mathbf{q}\cdot\delta\mathbf{q}\,\textrm{d}\Omega + \int_{\Omega} u\, \textrm{div}\, \delta\mathbf{q} \,\textrm{d}\Omega -\int_{\partial\Omega} u\, \delta\mathbf{q}\cdot\mathbf{n} \,\textrm{d}\Gamma &amp;= 0 \\
-\int_{\Omega}\textrm{div}\,\mathbf{q}\,\delta u \,\textrm{d}\Omega &amp;= \int_{\Omega}f\, \delta u \,\textrm{d}\Omega 
\end{align}
\]
</p>
<p> Since \(u=0\) on \(\partial\Omega\), the boundary term in \eqref{eq:flux_int_part} vanishes. Note that in this case the Dirichlet boundary condition on the field \(u\) \eqref{eq:bc} is imposed in the sense of natural boundary condition, which is typical for mixed formulations. We arrive at the mixed weak form of the problem \eqref{eq:poisson}-\eqref{eq:dirichlet}: Find \(\mathbf{q}\in H(\textrm{div};\Omega)\) and \(u\in L^2(\Omega)\) such that      </p><p class="formulaDsp">
\[
\begin{align}
\label{eq:weak_1}\int_{\Omega}\mathbf{q}\cdot\delta\mathbf{q}\,\textrm{d}\Omega + \int_{\Omega} u\, \textrm{div}\, \delta\mathbf{q} \,\textrm{d}\Omega &amp;= 0 &amp; \forall\, \delta\mathbf{q} \in H(\textrm{div};\Omega)\\
\label{eq:weak_2}\int_{\Omega}\textrm{div}\,\mathbf{q}\,\delta u \,\textrm{d}\Omega &amp;= -\int_{\Omega}f\, \delta u \,\textrm{d}\Omega &amp; \forall\, \delta u \in L^2(\Omega) 
\end{align}
\]
</p>
<p> where the following notations of function spaces were used:       </p><p class="formulaDsp">
\[
\begin{align}
L^2(\Omega) &amp;:= \left\{ u(\mathbf{x}) : \Omega \rightarrow R \;\left|\; \int_{\Omega}|u|^2\;\textrm{d}\Omega = ||u||^2_{\Omega} &lt; +\infty\right.\right\}
\\
H(\textrm{div};\Omega) &amp;:= \left\{ \mathbf{q} \in [L^2(\Omega)]^2 \;\left|\; \textrm{div}\:\mathbf{u}\in L^2(\Omega)\right.\right\}
\end{align}
\]
</p>
<p>As was mentioned above, one of the main benefits of the mixed formulation is associated with embedded error estimates. It is important to distinguish between error <em>indicators</em> which compute local measure of the error and error <em>estimators</em> which provide mathematically strict bounds on the global error. In this tutorial we will consider only the former, and in particular, will study a simple error indicator which represents the norm of difference between the gradient of field \(u\) and the flux \(\mathbf{q}\) computed over a finite element \(\Omega_e\), see <a class="el" href="citelist.html#CITEREF_repin2008posteriori">[62]</a> for more details:     </p><p class="formulaDsp">
\[
\begin{equation}
\label{eq:indic}\eta_e := ||\nabla u - \mathbf{q}||_{\Omega_e}^2.
\end{equation}
\]
</p>
<h1><a class="anchor" id="mix_poisson_code"></a>
Implementation</h1>
<p>Note that function <a class="el" href="struct_mixed_poisson.html#ace76888d23e848f665b4e3de005cb333" title="[Run programme]">MixedPoisson::runProblem()</a> is shorter than in previous tutorials, e.g. <a class="el" href="basic_tutorials_poisson_homogeneous.html">SCL-1: Poisson's equation (homogeneous BC)</a> since several functions are nested in <a class="el" href="struct_mixed_poisson.html#a024c71ab955d4c1792372e4af930454e" title="[Refine]">MixedPoisson::solveRefineLoop()</a>: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#ace76888d23e848f665b4e3de005cb333">MixedPoisson::runProblem</a>() {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#afe9a99f37f61e38306b9c35d7ceccb75">readMesh</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#adf58506481496fcc234714c617914c2d">setupProblem</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a5f642c1368d399e81521130b49aa4c90">createCommonData</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a024c71ab955d4c1792372e4af930454e">solveRefineLoop</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p>Furthermore, function <a class="el" href="struct_mixed_poisson.html#afe9a99f37f61e38306b9c35d7ceccb75" title="[Run programme]">MixedPoisson::readMesh()</a> is similar to the one in <a class="el" href="basic_tutorials_poisson_homogeneous.html">SCL-1: Poisson's equation (homogeneous BC)</a> and will not be discussed here. However, the function <a class="el" href="struct_mixed_poisson.html#adf58506481496fcc234714c617914c2d" title="[Read mesh]">MixedPoisson::setupProblem()</a> has features unique to the considered problem: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#adf58506481496fcc234714c617914c2d">MixedPoisson::setupProblem</a>() {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#a0e57a0b25756ae72ee7864646d564c0e">addDomainField</a>(<span class="stringliteral">&quot;U&quot;</span>, <a class="code hl_enumvalue" href="definitions_8h.html#a5ed4cb303bab8cd0673ae12e5bc73c12a0adffb24dae0c41be5b803f4d444f066">L2</a>, <a class="code hl_enumvalue" href="definitions_8h.html#a2ed4ed94b56d2843840bb7c55adcf0c5a54a26843865f4712f50a74fa4f8d025d">AINSWORTH_LEGENDRE_BASE</a>, 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> nb_quads = 0;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().get_number_entities_by_type(0, MBQUAD, nb_quads);</div>
<div class="line">  <span class="keyword">auto</span> base = <a class="code hl_enumvalue" href="definitions_8h.html#a2ed4ed94b56d2843840bb7c55adcf0c5a54a26843865f4712f50a74fa4f8d025d">AINSWORTH_LEGENDRE_BASE</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (nb_quads) {</div>
<div class="line">    <span class="comment">// AINSWORTH_LEGENDRE_BASE is not implemented for HDIV/HCURL space on quads</span></div>
<div class="line">    base = <a class="code hl_enumvalue" href="definitions_8h.html#a2ed4ed94b56d2843840bb7c55adcf0c5a9b4f9fbc1a88eda9b2cde0df10ca23bf">DEMKOWICZ_JACOBI_BASE</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Note that in 2D case HDIV and HCURL spaces are isomorphic, and therefore</span></div>
<div class="line">  <span class="comment">// only base for HCURL has been implemented in 2D. Base vectors for HDIV space</span></div>
<div class="line">  <span class="comment">// are be obtained after rotation of HCURL base vectors by a right angle</span></div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#a0e57a0b25756ae72ee7864646d564c0e">addDomainField</a>(<span class="stringliteral">&quot;Q&quot;</span>, <a class="code hl_enumvalue" href="definitions_8h.html#a5ed4cb303bab8cd0673ae12e5bc73c12aa30e505d5df1a8d715b9d175cd97ae82">HCURL</a>, base, 1);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#a717238cb999ebe609001c5ef2d857afe">thetaParam</a> = 0.5;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="namespace_mo_f_e_m.html#a39dee16669d6cb1de02b0e611a7a0d0e">PetscOptionsGetReal</a>(PETSC_NULL, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;-theta&quot;</span>, &amp;<a class="code hl_variable" href="struct_mixed_poisson.html#a717238cb999ebe609001c5ef2d857afe">thetaParam</a>, PETSC_NULL);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#a1af06c4ad4148fe9cf8d73598444597d">indicTolerance</a> = 1e-3;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="namespace_mo_f_e_m.html#a39dee16669d6cb1de02b0e611a7a0d0e">PetscOptionsGetReal</a>(PETSC_NULL, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;-indic_tol&quot;</span>, &amp;<a class="code hl_variable" href="struct_mixed_poisson.html#a1af06c4ad4148fe9cf8d73598444597d">indicTolerance</a>,</div>
<div class="line">                             PETSC_NULL);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a> = 2;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="namespace_mo_f_e_m.html#a2d7af8e1af9a42f3180d8cc96f8f8c06">PetscOptionsGetInt</a>(PETSC_NULL, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;-order&quot;</span>, &amp;<a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a>, PETSC_NULL);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#ab233701869a6020eb4a2cb348bd7978d">setFieldOrder</a>(<span class="stringliteral">&quot;U&quot;</span>, <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a>);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#ab233701869a6020eb4a2cb348bd7978d">setFieldOrder</a>(<span class="stringliteral">&quot;Q&quot;</span>, <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a> + 1);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#acf413f83e47d1e092a8d5fdb27996cbf">setUp</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().get_entities_by_dimension(0, 2, <a class="code hl_variable" href="struct_mixed_poisson.html#a3636079317f99a73835b57c0d9a2e2fa">domainEntities</a>);</div>
<div class="line">  <a class="code hl_class" href="class_tag.html">Tag</a> th_order;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ORDER&quot;</span>, MB_TYPE_INTEGER, th_order);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span> ent : <a class="code hl_variable" href="struct_mixed_poisson.html#a3636079317f99a73835b57c0d9a2e2fa">domainEntities</a>) {</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_set_data(th_order, &amp;ent, 1, &amp;<a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p>First, we add domain fields for the flux \(\mathbf{q}\) (choosing space <code>HCURL</code>) and for \(u\) (space <code>L2</code>). Space <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> in 2D is defined as:   </p><p class="formulaDsp">
\[
H(\textrm{curl};\Omega) := \left\{ \mathbf{q} \in [L^2(\Omega)]^2 \;\left|\; \textrm{curl}\:\mathbf{u}\in L^2(\Omega)\right.\right\}
\]
</p>
<p> It is important to note that choosing the <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> space for fluxes is not a mistake here. In turns out that in 2D case spaces <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> and <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> are isomorphic, and therefore only base for <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> has been implemented in 2D. Base vectors for <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> space can be easily obtained after rotation of <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> space base vectors by a right angle, see <a class="el" href="citelist.html#CITEREF_boffi2013mixed">[14]</a> for more details. Note also that bases of both <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> and <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> are vectorial, and, therefore, only 1 coefficient per base function is required for vector field \(\mathbf{q}\).</p>
<p>Next, user-defined orders are set for the fields: if \(p\) is the order for the flux \(\mathbf{q}\in H(\textrm{div};\Omega)\), then order for the field \(u\in L^2(\Omega)\) is \((p-1)\) which is required to satisfy the inf-sup (LBB) stability conditions <a class="el" href="citelist.html#CITEREF_boffi2013mixed">[14]</a>. Finally, since in this tutorial we will discuss the implementation of adaptive p-refinement, the user-defined approximation order \(p\) is stored in the MOAB database on <em>tags</em> of each domain element.</p>
<p>Setting the integration rule in function <a class="el" href="struct_mixed_poisson.html#ac2e5224a198d7684e5d483759f3330ff" title="[Set up problem]">MixedPoisson::setIntegrationRules()</a> is similar to other tutorials: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#ac2e5224a198d7684e5d483759f3330ff">MixedPoisson::setIntegrationRules</a>() {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> rule = [](int, int, <span class="keywordtype">int</span> p) -&gt; <span class="keywordtype">int</span> { <span class="keywordflow">return</span> 2 * p; };</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a> *pipeline_mng = <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a>&gt;();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#ac81815a59f303199fc9f63e598040f00">setDomainLhsIntegrationRule</a>(rule);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#a74a8e58051a774d8259456da159cba23">setDomainRhsIntegrationRule</a>(rule);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p> The highest order of the integrand is found in the diagonal term in Eq. \eqref{eq:weak_1}, and therefore the rule is set to \((2 p + 1)\), where \(p\) is order of base functions for fluxes. Note that the order is increased by 1 to accommodate for the case of the higher order geometry.</p>
<p>As was mentioned above, functions <a class="el" href="struct_mixed_poisson.html#a13a2cebc7b75e8bccb2254717d9f1911" title="[Create common data]">MixedPoisson::assembleSystem()</a>, <a class="el" href="struct_mixed_poisson.html#a80d58aacf7ce5cb98e5dd04f45d8c2dd" title="[Assemble system]">MixedPoisson::solveSystem()</a>, <a class="el" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f" title="[Solve and refine loop]">MixedPoisson::checkError()</a> and <a class="el" href="struct_mixed_poisson.html#a378140831e5d2f1d0b59b103fbb9a07d" title="[Check error]">MixedPoisson::outputResults()</a> are nested in <a class="el" href="struct_mixed_poisson.html#a024c71ab955d4c1792372e4af930454e" title="[Refine]">MixedPoisson::solveRefineLoop()</a>. Note that first, these functions are called outside the loop: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#a024c71ab955d4c1792372e4af930454e">MixedPoisson::solveRefineLoop</a>() {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a13a2cebc7b75e8bccb2254717d9f1911">assembleSystem</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#ac2e5224a198d7684e5d483759f3330ff">setIntegrationRules</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a80d58aacf7ce5cb98e5dd04f45d8c2dd">solveSystem</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f">checkError</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a378140831e5d2f1d0b59b103fbb9a07d">outputResults</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> iter_num = 1;</div>
<div class="line">  <span class="keywordflow">while</span> (fabs(<a class="code hl_variable" href="struct_mixed_poisson.html#a1af06c4ad4148fe9cf8d73598444597d">indicTolerance</a>) &gt; DBL_EPSILON &amp;&amp;</div>
<div class="line">         <a class="code hl_variable" href="struct_mixed_poisson.html#a5461dcc3360542695e16cffc9803964d">totErrorIndicator</a> &gt; <a class="code hl_variable" href="struct_mixed_poisson.html#a1af06c4ad4148fe9cf8d73598444597d">indicTolerance</a>) {</div>
<div class="line">    <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::inform) &lt;&lt; <span class="stringliteral">&quot;Refinement iteration &quot;</span> &lt;&lt; iter_num;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#af32c655292c003f99410c54e9bda5a0e">refineOrder</a>(iter_num);</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a13a2cebc7b75e8bccb2254717d9f1911">assembleSystem</a>();</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#ac2e5224a198d7684e5d483759f3330ff">setIntegrationRules</a>();</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a80d58aacf7ce5cb98e5dd04f45d8c2dd">solveSystem</a>();</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f">checkError</a>(iter_num);</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#a378140831e5d2f1d0b59b103fbb9a07d">outputResults</a>(iter_num);</div>
<div class="line"> </div>
<div class="line">    iter_num++;</div>
<div class="line">    <span class="keywordflow">if</span> (iter_num &gt; 100)</div>
<div class="line">      SETERRQ(PETSC_COMM_SELF, <a class="code hl_enumvalue" href="definitions_8h.html#a980bf270a5c3f2f984262f7e74786a2eaa4d3788e72b298f5fc901644e3f1ad95">MOFEM_OPERATION_UNSUCCESSFUL</a>,</div>
<div class="line">              <span class="stringliteral">&quot;Too many refinement iterations&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p> If user-defined number of p-refinement iterations is greater or equal to 1, then the loop starts from the refinement procedure and, subsequently, calls to <a class="el" href="struct_mixed_poisson.html#a13a2cebc7b75e8bccb2254717d9f1911" title="[Create common data]">MixedPoisson::assembleSystem()</a>, <a class="el" href="struct_mixed_poisson.html#a80d58aacf7ce5cb98e5dd04f45d8c2dd" title="[Assemble system]">MixedPoisson::solveSystem()</a>, <a class="el" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f" title="[Solve and refine loop]">MixedPoisson::checkError()</a> and <a class="el" href="struct_mixed_poisson.html#a378140831e5d2f1d0b59b103fbb9a07d" title="[Check error]">MixedPoisson::outputResults()</a> are repeated. We will now consider these functions in more detail.</p>
<h2><a class="anchor" id="mix_poisson_assemble"></a>
Assembling the system</h2>
<div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#a13a2cebc7b75e8bccb2254717d9f1911">MixedPoisson::assembleSystem</a>() {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a> *pipeline_mng = <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a>&gt;();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#a4daac802fcdd9c31639d1c1d4a2a608f">getDomainLhsFE</a>().reset();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#a0d2c10375809102ca76959b5cc21ef9e">getDomainRhsFE</a>().reset();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().clear();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#ga4b4225b4e1f114d604552ad8ec176486">getOpDomainLhsPipeline</a>().clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_struct" href="struct_add_h_o_ops.html">AddHOOps&lt;2, 2, 2&gt;::add</a>(pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#ga4b4225b4e1f114d604552ad8ec176486">getOpDomainLhsPipeline</a>(), {HDIV});</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> beta = [](<span class="keyword">const</span> <a class="code hl_class" href="classdouble.html">double</a>, <span class="keyword">const</span> <a class="code hl_class" href="classdouble.html">double</a>, <span class="keyword">const</span> <a class="code hl_class" href="classdouble.html">double</a>) { <span class="keywordflow">return</span> 1; };</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#ga4b4225b4e1f114d604552ad8ec176486">getOpDomainLhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_typedef" href="mixed__poisson_8cpp.html#ad5fcc4bac8085facbda2ab02026c1191">OpHdivHdiv</a>(<span class="stringliteral">&quot;Q&quot;</span>, <span class="stringliteral">&quot;Q&quot;</span>, beta));</div>
<div class="line">  <span class="keyword">auto</span> unity = []() { <span class="keywordflow">return</span> 1; };</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#ga4b4225b4e1f114d604552ad8ec176486">getOpDomainLhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_typedef" href="mixed__poisson_8cpp.html#af56f8bd86f11aa45c132148656abf7e0">OpHdivU</a>(<span class="stringliteral">&quot;Q&quot;</span>, <span class="stringliteral">&quot;U&quot;</span>, unity, <span class="keyword">true</span>));</div>
<div class="line">  <span class="keyword">auto</span> <a class="code hl_variable" href="poisson__2d__dis__galerkin_8cpp.html#a5c4ed60873dc8033ed4e8267dd4b4a1e">source</a> = [&amp;](<span class="keyword">const</span> <span class="keywordtype">double</span> x, <span class="keyword">const</span> <span class="keywordtype">double</span> y, <span class="keyword">const</span> <span class="keywordtype">double</span> z) {</div>
<div class="line">    <span class="keywordflow">return</span> -<a class="code hl_function" href="struct_mixed_poisson.html#a78b919243f1f8567cd2ff976d366f51f">sourceFunction</a>(x, y, z);</div>
<div class="line">  };</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_typedef" href="mixed__poisson_8cpp.html#a27868d30570429ad9e75b3ec3ae858b1">OpDomainSource</a>(<span class="stringliteral">&quot;U&quot;</span>, <a class="code hl_variable" href="poisson__2d__dis__galerkin_8cpp.html#a5c4ed60873dc8033ed4e8267dd4b4a1e">source</a>));</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p> Assembly of the system requires first computation of the Jacobian matrix, its inverse and the determinant. Furthermore, as the <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(curl)</a> space was chosen for approximation of the flux field, the transformation of the base to <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> space (rotation by the right angle of the base vectors) is obtained by pushing the corresponding operator. Moreover, as the base for <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> space is vectorial, the contravariant Piola transform is required, see <a class="el" href="citelist.html#CITEREF_boffi2013mixed">[14]</a> for more details, and the associated operator is also pushed to the pipeline. Upon these preliminary steps, only three additional operators are needed to assemble the discretized version of the system \eqref{eq:weak_1}- \eqref{eq:weak_2}:</p><ul>
<li>Operator <a class="el" href="thermo__elastic_8cpp.html#addcb0b3a8434c837ca3a9b503ce63171" title="[Linear elastic problem]">OpHdivHdiv()</a> is used to compute the diagonal term in \eqref{eq:weak_1};</li>
<li>Operator <a class="el" href="mixed__poisson_8cpp.html#af56f8bd86f11aa45c132148656abf7e0">OpHdivU()</a> computes off-diagonal (symmetric) terms in \eqref{eq:weak_1} and \eqref{eq:weak_2}</li>
<li>Operator <a class="el" href="child__and__parent_8cpp.html#a275978a7d5332ab98ba22a4826dbbdfb">OpDomainSource()</a> assembles the source term in \eqref{eq:weak_2}.</li>
</ul>
<h2><a class="anchor" id="mix_poisson_error_op"></a>
Operators for computing error indicators</h2>
<p>The solution of the system is implemented in <a class="el" href="struct_mixed_poisson.html#a80d58aacf7ce5cb98e5dd04f45d8c2dd" title="[Assemble system]">MixedPoisson::solveSystem()</a> and is similar to other tutorials. However, function <a class="el" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f" title="[Solve and refine loop]">MixedPoisson::checkError()</a> deserves discussion here: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#a62593076a37410692b8a3202c4920c1f">MixedPoisson::checkError</a>(<span class="keywordtype">int</span> iter_num) {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a> *pipeline_mng = <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_pipeline_manager.html">PipelineManager</a>&gt;();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#a4daac802fcdd9c31639d1c1d4a2a608f">getDomainLhsFE</a>().reset();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_pipeline_manager.html#a0d2c10375809102ca76959b5cc21ef9e">getDomainRhsFE</a>().reset();</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_struct" href="struct_add_h_o_ops.html">AddHOOps&lt;2, 2, 2&gt;::add</a>(pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>(),</div>
<div class="line">                                {HDIV, L2});</div>
<div class="line"> </div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_struct" href="struct_mo_f_e_m_1_1_op_calculate_scalar_field_values.html">OpCalculateScalarFieldValues</a>(<span class="stringliteral">&quot;U&quot;</span>, <a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;approxVals));</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_struct" href="struct_mo_f_e_m_1_1_op_calculate_scalar_field_gradient.html">OpCalculateScalarFieldGradient&lt;2&gt;</a>(<span class="stringliteral">&quot;U&quot;</span>,</div>
<div class="line">                                            <a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;approxValsGrad));</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_struct" href="struct_mo_f_e_m_1_1_op_calculate_h_vec_vector_field.html">OpCalculateHVecVectorField&lt;3&gt;</a>(<span class="stringliteral">&quot;Q&quot;</span>, <a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;approxFlux));</div>
<div class="line">  pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#gac52cdc08eaadd124e0224d7d9e0a13f5">getOpDomainRhsPipeline</a>().push_back(</div>
<div class="line">      <span class="keyword">new</span> <a class="code hl_struct" href="struct_op_error.html">OpError</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>, <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>));</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;maxErrorIndicator = 0;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecZeroEntries(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> pipeline_mng-&gt;<a class="code hl_function" href="group__mofem__basic__interface.html#ga41f2fac8fb98a931dc7fc9e2239b2909">loopFiniteElements</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecAssemblyBegin(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecAssemblyEnd(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecGhostUpdateBegin(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec, INSERT_VALUES,</div>
<div class="line">                             SCATTER_FORWARD);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecGhostUpdateEnd(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec, INSERT_VALUES,</div>
<div class="line">                           SCATTER_FORWARD);</div>
<div class="line"> </div>
<div class="line">  MPI_Allreduce(&amp;<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;maxErrorIndicator, &amp;<a class="code hl_variable" href="struct_mixed_poisson.html#a9a441face4d4a8cde0f47945f2472466">maxErrorIndicator</a>, 1,</div>
<div class="line">                MPI_DOUBLE, MPI_MAX, <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a9b2bc8c1b980f49d31a0b5f7fbe756f5">get_comm</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> *array;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecGetArrayRead(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec, &amp;array);</div>
<div class="line">  <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::inform)</div>
<div class="line">      &lt;&lt; <span class="stringliteral">&quot;Global error indicator (max): &quot;</span> &lt;&lt; <a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;maxErrorIndicator;</div>
<div class="line">  <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::inform)</div>
<div class="line">      &lt;&lt; <span class="stringliteral">&quot;Global error indicator (total): &quot;</span></div>
<div class="line">      &lt;&lt; std::sqrt(array[<a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba16d3bb314f574423378062ec743ab030">CommonData::ERROR_INDICATOR_TOTAL</a>]);</div>
<div class="line">  <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::inform)</div>
<div class="line">      &lt;&lt; <span class="stringliteral">&quot;Global error L2 norm: &quot;</span></div>
<div class="line">      &lt;&lt; std::sqrt(array[<a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba5b6a5a2ac19a6a535a72ef33aeb02e6f">CommonData::ERROR_L2_NORM</a>]);</div>
<div class="line">  <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::inform)</div>
<div class="line">      &lt;&lt; <span class="stringliteral">&quot;Global error H1 seminorm: &quot;</span></div>
<div class="line">      &lt;&lt; std::sqrt(array[<a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fbab8b92f2013fd4eb3e6c2164898c07706">CommonData::ERROR_H1_SEMINORM</a>]);</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#a5461dcc3360542695e16cffc9803964d">totErrorIndicator</a> = std::sqrt(array[<a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba16d3bb314f574423378062ec743ab030">CommonData::ERROR_INDICATOR_TOTAL</a>]);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> VecRestoreArrayRead(<a class="code hl_variable" href="struct_mixed_poisson.html#abe8be43dc751861bb6b9b04e0667ae36">commonDataPtr</a>-&gt;petscVec, &amp;array);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tag&gt; tag_handles;</div>
<div class="line">  tag_handles.resize(4);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ERROR_L2_NORM&quot;</span>, MB_TYPE_DOUBLE, tag_handles[0]);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ERROR_H1_SEMINORM&quot;</span>, MB_TYPE_DOUBLE,</div>
<div class="line">                      tag_handles[1]);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ERROR_INDICATOR&quot;</span>, MB_TYPE_DOUBLE,</div>
<div class="line">                      tag_handles[2]);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ORDER&quot;</span>, MB_TYPE_INTEGER, tag_handles[3]);</div>
<div class="line"> </div>
<div class="line">  ParallelComm *pcomm =</div>
<div class="line">      ParallelComm::get_pcomm(&amp;<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>(), <a class="code hl_define" href="definitions_8h.html#a5fe7ca274d3c5ac11ac61888ce74bc13">MYPCOMM_INDEX</a>);</div>
<div class="line">  <span class="keywordflow">if</span> (pcomm == NULL)</div>
<div class="line">    SETERRQ(PETSC_COMM_WORLD, <a class="code hl_enumvalue" href="definitions_8h.html#a980bf270a5c3f2f984262f7e74786a2eac345e9ce83307109886a56dcaf5ab724">MOFEM_DATA_INCONSISTENCY</a>, <span class="stringliteral">&quot;Communicator not set&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  tag_handles.push_back(pcomm-&gt;part_tag());</div>
<div class="line">  std::ostringstream strm;</div>
<div class="line">  strm &lt;&lt; <span class="stringliteral">&quot;error_&quot;</span> &lt;&lt; iter_num &lt;&lt; <span class="stringliteral">&quot;.h5m&quot;</span>;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().write_file(strm.str().c_str(), <span class="stringliteral">&quot;MOAB&quot;</span>,</div>
<div class="line">                                      <span class="stringliteral">&quot;PARALLEL=WRITE_PART&quot;</span>, 0, 0,</div>
<div class="line">                                      tag_handles.data(), tag_handles.size());</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p> First, computation of the error and error indicators requires the same operators for Jacobian (inverse and determinant), transformation of the base for the space <a class="el" href="plastic_8cpp.html#a982cf43f120ff8978010e078bd49d9a3" title="Hardening.">H(div)</a> and contravariant Piola transform as were discussed above. Upon pushing those, we add operators for evaluating values of the field \(u\), its gradient, and the values of the flux \(\mathbf{q}\) at gauss points of the domain elements. Finally, before the loop over all finite elements is performed, the operator <a class="el" href="struct_mixed_poisson_1_1_op_error.html">MixedPoisson::OpError()</a> is pushed to the pipeline: </p><div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson_1_1_op_error.html#a2fb3b9a43b6e8e6440b7f948bc752c4d">MixedPoisson::OpError::doWork</a>(<span class="keywordtype">int</span> side, EntityType type,</div>
<div class="line">                                             <a class="code hl_struct" href="struct_mo_f_e_m_1_1_entities_field_data_1_1_ent_data.html">EntData</a> &amp;data) {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> nb_integration_pts = getGaussPts().size2();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> area = getMeasure();</div>
<div class="line">  <span class="keyword">auto</span> t_w = getFTensor0IntegrationWeight();</div>
<div class="line">  <span class="keyword">auto</span> t_val = <a class="code hl_function" href="namespace_mo_f_e_m.html#aa464ad90a188180427136b22e078ec7d">getFTensor0FromVec</a>(*(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;approxVals));</div>
<div class="line">  <span class="keyword">auto</span> t_val_grad = <a class="code hl_function" href="namespace_mo_f_e_m.html#a82e89fad6ef326b49efc9a72d08a7d9c">getFTensor1FromMat&lt;2&gt;</a>(*(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;approxValsGrad));</div>
<div class="line">  <span class="keyword">auto</span> t_flux = <a class="code hl_function" href="namespace_mo_f_e_m.html#a82e89fad6ef326b49efc9a72d08a7d9c">getFTensor1FromMat&lt;3&gt;</a>(*(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;approxFlux));</div>
<div class="line">  <span class="keyword">auto</span> t_coords = getFTensor1CoordsAtGaussPts();</div>
<div class="line">  <a class="code hl_class" href="class_f_tensor_1_1_tensor1.html">FTensor::Tensor1&lt;double, 2&gt;</a> t_diff;</div>
<div class="line">  <a class="code hl_class" href="class_f_tensor_1_1_index.html">FTensor::Index</a>&lt;<span class="charliteral">&#39;i&#39;</span>, 2&gt; <a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> error_l2 = 0;</div>
<div class="line">  <span class="keywordtype">double</span> error_h1 = 0;</div>
<div class="line">  <span class="keywordtype">double</span> error_ind = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> gg = 0; gg != nb_integration_pts; ++gg) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> alpha = t_w * area;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> diff = t_val - <a class="code hl_function" href="struct_mixed_poisson.html#ace22720c19bfaf1b8fa11672f151ed5f">MixedPoisson::analyticalFunction</a>(</div>
<div class="line">                              t_coords(0), t_coords(1), t_coords(2));</div>
<div class="line">    error_l2 += alpha * <a class="code hl_function" href="mixed__poisson_8cpp.html#a22f4e97ed7ca9e188dc4e074a1b2e5a7">sqr</a>(diff);</div>
<div class="line"> </div>
<div class="line">    VectorDouble vec = <a class="code hl_function" href="struct_mixed_poisson.html#a89cd37f53afcc7648530bd22b1ae43f2">MixedPoisson::analyticalFunctionGrad</a>(</div>
<div class="line">        t_coords(0), t_coords(1), t_coords(2));</div>
<div class="line">    <span class="keyword">auto</span> t_fun_grad = <a class="code hl_function" href="namespace_mo_f_e_m.html#afe06169e4d5ce00b60ad0ca6eb29a758">getFTensor1FromArray&lt;2, 2&gt;</a>(vec);</div>
<div class="line">    t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) = t_val_grad(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) - t_fun_grad(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>);</div>
<div class="line">    error_h1 += alpha * t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) * t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>);</div>
<div class="line"> </div>
<div class="line">    t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) = t_val_grad(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) - t_flux(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>);</div>
<div class="line">    error_ind += alpha * t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>) * t_diff(<a class="code hl_variable" href="hcurl__divergence__operator__2d_8cpp.html#a4c0436605284b64f6b0b5482594d86bc">i</a>);</div>
<div class="line"> </div>
<div class="line">    ++t_w;</div>
<div class="line">    ++t_val;</div>
<div class="line">    ++t_val_grad;</div>
<div class="line">    ++t_flux;</div>
<div class="line">    ++t_coords;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code hl_class" href="class_entity_handle.html">EntityHandle</a> ent = getFEEntityHandle();</div>
<div class="line">  <a class="code hl_class" href="class_tag.html">Tag</a> th_error_l2, th_error_h1, th_error_ind;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">MixedPoisson::getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>, <span class="stringliteral">&quot;ERROR_L2_NORM&quot;</span>, MB_TYPE_DOUBLE,</div>
<div class="line">                                    th_error_l2);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">MixedPoisson::getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>, <span class="stringliteral">&quot;ERROR_H1_SEMINORM&quot;</span>, MB_TYPE_DOUBLE,</div>
<div class="line">                                    th_error_h1);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">MixedPoisson::getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>, <span class="stringliteral">&quot;ERROR_INDICATOR&quot;</span>, MB_TYPE_DOUBLE,</div>
<div class="line">                                    th_error_ind);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> error_l2_norm = sqrt(error_l2);</div>
<div class="line">  <span class="keywordtype">double</span> error_h1_seminorm = sqrt(error_h1);</div>
<div class="line">  <span class="keywordtype">double</span> error_ind_local = sqrt(error_ind);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_set_data(th_error_l2, &amp;ent, 1, &amp;error_l2_norm);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_set_data(th_error_h1, &amp;ent, 1,</div>
<div class="line">                                        &amp;error_h1_seminorm);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a05b1cbd82bdbf0cdc8d4118366c68367">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_set_data(th_error_ind, &amp;ent, 1,</div>
<div class="line">                                        &amp;error_ind_local);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (error_ind_local &gt; <a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;maxErrorIndicator)</div>
<div class="line">    <a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;maxErrorIndicator = error_ind_local;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> index = <a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba5b6a5a2ac19a6a535a72ef33aeb02e6f">CommonData::ERROR_L2_NORM</a>;</div>
<div class="line">  <span class="keyword">constexpr</span> std::array&lt;int, CommonData::LAST_ELEMENT&gt; indices = {</div>
<div class="line">      <a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba5b6a5a2ac19a6a535a72ef33aeb02e6f">CommonData::ERROR_L2_NORM</a>, <a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fbab8b92f2013fd4eb3e6c2164898c07706">CommonData::ERROR_H1_SEMINORM</a>,</div>
<div class="line">      <a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fba16d3bb314f574423378062ec743ab030">CommonData::ERROR_INDICATOR_TOTAL</a>};</div>
<div class="line">  std::array&lt;double, CommonData::LAST_ELEMENT&gt; values;</div>
<div class="line">  values[0] = error_l2;</div>
<div class="line">  values[1] = error_h1;</div>
<div class="line">  values[2] = error_ind;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="namespace_mo_f_e_m.html#aef01d33cbe1d8ed916ce789bd25c4495">VecSetValues</a>(<a class="code hl_variable" href="struct_mixed_poisson_1_1_op_error.html#a3fc60125b377db0eddbd6408d9187b27">commonDataPtr</a>-&gt;petscVec, <a class="code hl_enumvalue" href="struct_mixed_poisson_1_1_common_data.html#a11fb77b164dd2f7cd02ac7da40b0b8fbaf97d217494e4a6fc2364c54eeb686428">CommonData::LAST_ELEMENT</a>,</div>
<div class="line">                      indices.data(), values.data(), ADD_VALUES);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p>In particular, operator <a class="el" href="struct_mixed_poisson_1_1_op_error.html">MixedPoisson::OpError</a> integrates over the domain elements following values:</p><ul>
<li>L2 norm of the error \(||u^h - u^*||_{\Omega_e}^2\)</li>
<li>H1 seminorm of the error \(||\nabla u^h - \nabla u^*||_{\Omega_e}^2\)</li>
<li>error indicator \(\eta_e=||\nabla u^h - \mathbf{q}^h||_{\Omega_e}^2\)</li>
</ul>
<p>These values are then stored as tags on the corresponding elements in the MOAB database, and, furthermore, are summed up with contributions from other elements to provide the global values.</p>
<h2><a class="anchor" id="mix_poisson_ref"></a>
Algorithm of adaptive p-refinement</h2>
<p>What remains to be discussed is probably the most important part of this tutorial: how the computed values of the error indicator are used to drive adaptive p-refinement. The corresponding algorithm is implemented in <a class="el" href="struct_mixed_poisson.html#af32c655292c003f99410c54e9bda5a0e" title="[Solve]">MixedPoisson::refineOrder()</a>:</p>
<div class="fragment"><div class="line"><span class="comment"></span><a class="code hl_typedef" href="namespace_mo_f_e_m_1_1_exceptions.html#a8fb6351034eac301fc47fdf2748c1b45">MoFEMErrorCode</a> <a class="code hl_function" href="struct_mixed_poisson.html#af32c655292c003f99410c54e9bda5a0e">MixedPoisson::refineOrder</a>(<span class="keywordtype">int</span> iter_num) {</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#a6c0b52978f1abc88bf8a1ba70b7308e3">MoFEMFunctionBegin</a>;</div>
<div class="line">  <a class="code hl_class" href="class_tag.html">Tag</a> th_error_ind, th_order;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ERROR_INDICATOR&quot;</span>, MB_TYPE_DOUBLE, th_error_ind);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="struct_mixed_poisson.html#aef3ea421b0d4a913532ef280f5efdd44">getTagHandle</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>, <span class="stringliteral">&quot;ORDER&quot;</span>, MB_TYPE_INTEGER, th_order);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Range&gt; refinement_levels;</div>
<div class="line">  refinement_levels.resize(iter_num + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span> ent : <a class="code hl_variable" href="struct_mixed_poisson.html#a3636079317f99a73835b57c0d9a2e2fa">domainEntities</a>) {</div>
<div class="line">    <span class="keywordtype">double</span> err_indic = 0;</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_get_data(th_error_ind, &amp;ent, 1, &amp;err_indic);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="dg__projection_8cpp.html#ad7eceded84ace5678d9df3e44f47d475">order</a>, new_order;</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_get_data(th_order, &amp;ent, 1, &amp;<a class="code hl_variable" href="dg__projection_8cpp.html#ad7eceded84ace5678d9df3e44f47d475">order</a>);</div>
<div class="line">    new_order = <a class="code hl_variable" href="dg__projection_8cpp.html#ad7eceded84ace5678d9df3e44f47d475">order</a> + 1;</div>
<div class="line">    <a class="code hl_class" href="class_range.html">Range</a> refined_ents;</div>
<div class="line">    <span class="keywordflow">if</span> (err_indic &gt; <a class="code hl_variable" href="struct_mixed_poisson.html#a717238cb999ebe609001c5ef2d857afe">thetaParam</a> * <a class="code hl_variable" href="struct_mixed_poisson.html#a9a441face4d4a8cde0f47945f2472466">maxErrorIndicator</a>) {</div>
<div class="line">      refined_ents.insert(ent);</div>
<div class="line">      <a class="code hl_class" href="class_range.html">Range</a> adj;</div>
<div class="line">      <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().get_adjacencies(&amp;ent, 1, 1, <span class="keyword">false</span>, adj,</div>
<div class="line">                                               moab::Interface::UNION);</div>
<div class="line">      refined_ents.merge(adj);</div>
<div class="line">      refinement_levels[new_order - <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a>].merge(refined_ents);</div>
<div class="line">      <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a174e70b67f4f235d096d3c45d865645b">get_moab</a>().tag_set_data(th_order, &amp;ent, 1, &amp;new_order);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ll = 1; ll &lt; refinement_levels.size(); ll++) {</div>
<div class="line">    <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_comm_interface.html">CommInterface</a>&gt;()-&gt;synchroniseEntities(</div>
<div class="line">        refinement_levels[ll]);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a> + ll &gt; 8) {</div>
<div class="line">      <a class="code hl_define" href="group__mofem__log__manager.html#ga19fe81dc9081ceb92ced847e619ca654">MOFEM_LOG</a>(<span class="stringliteral">&quot;EXAMPLE&quot;</span>, Sev::warning)</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;setting approximation order higher than 8 is not currently &quot;</span></div>
<div class="line">             <span class="stringliteral">&quot;supported&quot;</span></div>
<div class="line">          &lt;&lt; endl;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="group__mofem__field.html#ga86f0c16b69cc30dabc5d7dd292299b07">set_field_order</a>(refinement_levels[ll], <span class="stringliteral">&quot;U&quot;</span>, <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a> + ll);</div>
<div class="line">      <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="group__mofem__field.html#ga86f0c16b69cc30dabc5d7dd292299b07">set_field_order</a>(refinement_levels[ll], <span class="stringliteral">&quot;Q&quot;</span>,</div>
<div class="line">                                    <a class="code hl_variable" href="struct_mixed_poisson.html#a5d4f1a2bf28890eb9b904691abd3e78d">initOrder</a> + ll + 1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_comm_interface.html">CommInterface</a>&gt;()-&gt;synchroniseFieldEntities(<span class="stringliteral">&quot;Q&quot;</span>);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_comm_interface.html">CommInterface</a>&gt;()-&gt;synchroniseFieldEntities(<span class="stringliteral">&quot;U&quot;</span>);</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="group__mofem__field.html#ga126ea0bb04802f9d1946435279c3da56">build_fields</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="group__mofem__fe.html#ga735f920686a9c958073ec14ea0dc1da0">build_finite_elements</a>();</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_core_interface.html#a727653d1367e758daf2a74cb65d4dfa5">build_adjacencies</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#af40bfb3937afc0f2912d6981fe039789">getBitRefLevel</a>());</div>
<div class="line">  <a class="code hl_variable" href="struct_mixed_poisson.html#aa6ff18bcaee11f40d961b8fd08bf097f">mField</a>.<a class="code hl_function" href="struct_mo_f_e_m_1_1_unknown_interface.html#a7ab248ec45fca778800dcd92e5171beb">getInterface</a>&lt;<a class="code hl_struct" href="struct_mo_f_e_m_1_1_problems_manager.html">ProblemsManager</a>&gt;()-&gt;buildProblemFromFields = PETSC_TRUE;</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#add80e5ef5f847b2d4b637029f0f671c3">CHKERR</a> <a class="code hl_function" href="group__dm.html#gaeb19fd36deebd559af7d225a8711500e">DMSetUp_MoFEM</a>(<a class="code hl_variable" href="struct_mixed_poisson.html#a2a03c195e8cb310e8faf50ce4cbe408d">simpleInterface</a>-&gt;<a class="code hl_function" href="struct_mo_f_e_m_1_1_simple.html#a9261d3ef9b39a00cb7d0acc612702275">getDM</a>());</div>
<div class="line">  <a class="code hl_define" href="definitions_8h.html#acb0a46d159695a01bf667313b7788b45">MoFEMFunctionReturn</a>(0);</div>
<div class="line">}<span class="comment"></span></div>
</div><!-- fragment --><p>The algorithm starts by looping over all domain elements and reading the current approximation order and the value of the error indicator from <em>tags</em> of the MOAB database. If for a given element the local indicator is greater than the mean value over the whole domain, i.e.     </p><p class="formulaDsp">
\[
\begin{equation}
\label{eq:crit}\eta_e&gt;\frac{1}{N}\sum_{e=1}^{N}\eta_e,
\end{equation}
\]
</p>
<p> where \(N\) is total number of domain elements, then such element is added to the refinement level corresponding to its current approximation order. Once the criterion \eqref{eq:crit} is checked for all elements in the domain, the approximation order \(p\) is increased by 1 only for elements marked for the refinement on the current iteration.</p>
<h1><a class="anchor" id="mix_poisson_example"></a>
Example</h1>
<p>To demonstrate the discussed above implementation of the mixed form, we consider the Poisson equation in the rectangular 2D domain with Dirichlet boundary conditions prescribed on the whole boundary:      </p><p class="formulaDsp">
\[
\begin{cases}
-\textrm{div}\:(\nabla u) = f &amp;\textrm{in}\; \Omega := \left(-\frac{1}{2};\frac{1}{2}\right)\times\left(-\frac{1}{2};\frac{1}{2}\right)\\
u = 0 &amp;\textrm{on}\; \partial\Omega
\end{cases}
\]
</p>
<p> For testing purposes, we will construct the problem for a given solution:   </p><p class="formulaDsp">
\[
u^*(x,y)= e^{-100(x^2 + y^2)}  \cos \pi x \cos \pi y
\]
</p>
<p> The gradient of this functions is       </p><p class="formulaDsp">
\[
\nabla u^* =
\begin{bmatrix} 
-e^{-100(x^2 + y^2)} (200 x \cos\pi x + \pi \sin\pi x) \cos\pi y\\ 
-e^{-100(x^2 + y^2)} (200 y \cos\pi y + \pi \sin\pi y) \cos\pi x
\end{bmatrix}, 
\]
</p>
<p> see <a class="el" href="#mixed_poisson_figure_1">Figure 1</a>, while the source term reads:   </p><p class="formulaDsp">
\[
f(x,y) = -e^{-100(x^2 + y^2)} \Bigl\{400 \pi (x \cos\pi y \sin\pi x + y \cos\pi x \sin \pi y) +2\left[20000 (x^2 + y^2) - 200 - \pi^2 \right]\cos\pi x \cos\pi y  \Bigr\}
\]
</p>
<p><a class="anchor" id="mixed_poisson_figure_1"></a></p><div class="image">
<img src="function_and_gradient.png" alt="" width="1000px"/>
<div class="caption">
Figure 1: Analytical solution and the norm of its gradient</div></div>
<p>First, we will verify the implementation by running the code without the refinement loop: </p><div class="fragment"><div class="line">./mixed_poisson -file_name test.h5m -base_order 2</div>
</div><!-- fragment --><p> Using meshes with different element sizes and setting different approximation orders, we can study the convergence of e.g. field \(u\), see <a class="el" href="#mixed_poisson_figure_2">Figure 2(a)</a>, which for the considered mixed formulation satisfies the following <em>a priori</em> error bound, see <a class="el" href="citelist.html#CITEREF_boffi2013mixed">[14]</a>   </p><p class="formulaDsp">
\[
||u^h-u^*||_{\Omega}\leq C(u,\mathbf{q})\,h^{p}
\]
</p>
<p> where \(h\) is the element size, \(p\) is approximation order for fluxes field \(\mathbf{q}\) and order for field \(u\) is \((p-1)\).</p>
<p><a class="anchor" id="mixed_poisson_figure_2"></a></p><div class="image">
<img src="conv_study.pdf" alt="" width="1000px"/>
<div class="caption">
Figure 2: L2 error of the numerical solution for different approximations orders with respect to (a) element size, (b) number of DOFs</div></div>
<p>Furthermore, we can plot the values of the local errors and local error indicators \(\eta_e\), given by \eqref{eq:indic}. <a class="el" href="#mixed_poisson_figure_3">Figure 3</a> shows that the considered error indicator (difference between the gradient of field u and the flux) is very close to the H1 seminorm of the error computed using the analytical solution. Moreover, the indicator is very effective in highlighting the regions where the L2-norm of the solution is pronounced.</p>
<p><a class="anchor" id="mixed_poisson_figure_3"></a></p><div class="image">
<img src="error_indicators.jpg" alt="" width="1000px"/>
<div class="caption">
Figure 3: Local error and error indicator</div></div>
<p>Next, we run the code invoking the adaptive p-refinement: </p><div class="fragment"><div class="line">./mixed_poisson -file_name test.h5m -base_order 2 -ref_iter_num 10</div>
</div><!-- fragment --><p> In this case, we can observe coherent evolution of the approximation orders saved on element tags and the corresponding distribution of the error in the domain, see <a class="el" href="#mixed_poisson_figure_4">Figure 4</a>:</p>
<p><a class="anchor" id="mixed_poisson_figure_4"></a></p><div class="image">
<img src="adaptive_refinement.gif" alt="" width="1000px"/>
<div class="caption">
Figure 4: Approximation order and local error for several iterations of the adaptive p-refinement</div></div>
<p>Finally we extend the convergence analysis and plot the error as a function of number of DOFs used in simulation, see <a class="el" href="#mixed_poisson_figure_2">Figure 2(b)</a>. We can observe in this simple example the effectiveness of using the p-adaptivity, driven by the error indicator. Indeed, such an approach, which is increasing approximation order only in regions where the error is pronounced, requires much less DOFs then the approach based on global h- or p-refinement to obtain the same accuracy of the solution. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr cla ss="footer" />
<style>
  img[src="UoGLogo.png"] {
    height: 20px;
    padding-top: 0px;
    padding-right: 1px;
    padding-bottom: 3px;
    padding-left: 6px;
  }
</style>
<address class="footer">
  <small>
    Generated by
    <a href="http://www.doxygen.org/index.html"> Doxygen </a> 1.12.0
    and hosted at
    <a href="http://www.gla.ac.uk/schools/engineering/">
      <img class="footer" src="UoGLogo.png" alt="University of Glasgow" />
    </a>
  </small>
</address>
</body>
</html>
